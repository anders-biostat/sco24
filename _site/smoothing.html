<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mathematics of single-cell omics - Smoothing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Smoothing</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="some-example-data-and-the-problem-setting" class="level3">
<h3 class="anchored" data-anchor-id="some-example-data-and-the-problem-setting">Some example data, and the problem setting</h3>
<p>The following code produces a function whose graphs shows several ups and downs. Don’t pay to much attention on how the function works; just look at its graph.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-1_d27ca587c2aac0d8d5c36da9cae62bcc">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( splines )</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>spline_coefs <span class="ot">=</span> <span class="fu">c</span>( .<span class="dv">1</span>, .<span class="dv">1</span>, .<span class="dv">1</span>, .<span class="dv">3</span>, <span class="fl">1.3</span>, <span class="fl">1.3</span>, <span class="sc">-</span>.<span class="dv">1</span>, <span class="sc">-</span>.<span class="dv">1</span>, <span class="sc">-</span>.<span class="dv">1</span>, .<span class="dv">3</span>, .<span class="dv">3</span>  )</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>spline_knots <span class="ot">=</span> <span class="fu">c</span>( .<span class="dv">1</span>, .<span class="dv">1</span>, .<span class="dv">32</span>, .<span class="dv">35</span>, .<span class="dv">36</span>, .<span class="dv">48</span>, .<span class="dv">7</span> )</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>true_function <span class="ot">&lt;-</span> <span class="cf">function</span>(x)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">bs</span>( x, <span class="at">knots=</span>spline_knots, <span class="at">intercept=</span><span class="cn">TRUE</span> ) <span class="sc">%*%</span> spline_coefs</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>xg <span class="ot">&lt;-</span> <span class="fu">seq</span>( <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out=</span><span class="dv">1000</span> )</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">type=</span><span class="st">"l"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s assume, we have some complicated apparatus or some complex system, which responds to some input or stimulus with an output or response governed by this function. Unfortunately, the measurement of the response is very noisy, and we have measurements only for a limited number of stimulus values.</p>
<p>Here’s the 100 stimulus values:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-2_aa301cd8e2fa087d9aefcd0e4c516554">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">13245769</span> )</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>( n )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here’s the measured responses:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-3_e03614e181197c0ef7e9e75de691b0a9">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">true_function</span>( x ) <span class="sc">+</span> <span class="fu">rnorm</span>( n, <span class="at">sd=</span>.<span class="dv">1</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is how our data looks like:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-4_fd8fa59af55b7fb91d24dd912cc5320f">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Can we reconstruct the original function from this noisy data?</p>
</section>
<section id="binned-means" class="level3">
<h3 class="anchored" data-anchor-id="binned-means">Binned means</h3>
<p>The simplest idea would be to bin the x-values and calculate for each bin of x values an average of the y values, e.g.&nbsp;one average of the y values corresponding to the x-values x from 0 to 0.1, one average for x between .1 and .2, etc.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-5_76a6e308ee3ad6fde640c467d1a1a33d">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>( <span class="fu">library</span>( tidyverse ) )</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>( x, y ) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>( <span class="at">xbin =</span> <span class="fu">cut_width</span>( x, .<span class="dv">1</span>, <span class="at">center=</span><span class="fl">0.05</span> ) ) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>( xbin ) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_all</span>( mean ) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_point</span>( <span class="fu">aes</span>( xbin, y ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="kernel-smoothing" class="level3">
<h3 class="anchored" data-anchor-id="kernel-smoothing">Kernel smoothing</h3>
<p>The hard cuts might introduce artefacts. An alternative is the following:</p>
<p>To get a smooth <span class="math inline">\(y\)</span> value for a given value <span class="math inline">\(x_0\)</span>, calculate a <em>weighted</em> mean of the <span class="math inline">\(y\)</span> values, where the weight depends on the distance <span class="math inline">\(x-x_0\)</span> and is 0 for distance larger than some “smoothing bandwidth” <span class="math inline">\(h\)</span>:</p>
<p><span class="math display">\[ f_\text{sm}(x_0) = \frac{ \sum_i y_i w_i }{\sum_i w_i}, \]</span> where the weights depend on some “kernel function” <span class="math inline">\(f_\text{K}\)</span> as <span class="math display">\[ w_i = f_\text{K}\left(\frac{x-x_0}{h}\right).\]</span></p>
<p>There are many choices for kernel functions. Wikipedia <a href="https://en.wikipedia.org/wiki/Kernel_(statistics)">lists</a> the popular ones.</p>
<p>A kernel function should be symmetric <span class="math inline">\(f_\text{K}(x)=f_\text{K}(-x)\)</span>, have a single mode at 0, be continuous, perhaps also differentiable, and small or even zero for <span class="math inline">\(|x|&gt;0\)</span>. We use the tricube kernel <span class="math display">\[ f_\text{tc}(u) = \left\{ \begin{align}
\frac{70}{81} \left(1-|u|^3\right)^3 \qquad &amp; \text{for } |u| \le 1
\\
0 \qquad &amp; \text{otherwise}
\end{align} \right.\]</span></p>
<p>The prefactor merely ensures that the function has a unit integral. As we divide by the weight sum anyway, we don’t need it:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-6_b8f456d45c1a33ccb63aaf9e9f2d95d6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tricube <span class="ot">&lt;-</span> <span class="cf">function</span>(u)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>( <span class="fu">abs</span>(u) <span class="sc">&lt;</span> <span class="dv">1</span>, ( <span class="dv">1</span> <span class="sc">-</span> <span class="fu">abs</span>(u)<span class="sc">^</span><span class="dv">3</span> )<span class="sc">^</span><span class="dv">3</span>, <span class="dv">0</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the smoothing function <span class="math inline">\(f_\text{sm}\)</span> from above, now in R:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-7_bd5d41aed98c8021848aefaead1eadd4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>kernel_smooth <span class="ot">&lt;-</span> <span class="cf">function</span>( x0, x, y, h ) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> h )</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>( w <span class="sc">*</span> y ) <span class="sc">/</span> <span class="fu">sum</span>( w )</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use it to draw a smoothed plot:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-8_f0b052848101e8d48fdd17bb67fe6c43">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>xg <span class="ot">&lt;-</span> <span class="fu">seq</span>( <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">300</span> )</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  xg, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>( xg, kernel_smooth, x, y, <span class="at">h=</span>.<span class="dv">1</span>), </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">ylim=</span><span class="fu">c</span>( <span class="sc">-</span>.<span class="dv">1</span>, <span class="fl">1.5</span> ) )</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>( x, y )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For comparison, we have added to the smoothing curve (red) the true function (blue), from which we had sampled our data.</p>
<section id="bandwidth-choice" class="level4">
<h4 class="anchored" data-anchor-id="bandwidth-choice">Bandwidth choice</h4>
<p>Experiment a bit with values for <span class="math inline">\(h\)</span>, the kernel width (also called the “smoothing bandwidth”).</p>
<p>How to choose a good value? What’s the trade-off?</p>
</section>
</section>
<section id="local-regression" class="level3">
<h3 class="anchored" data-anchor-id="local-regression">Local regression</h3>
<p>(also known as “LOESS smoothing” or “LOWESS smoothing”, for “locally estimated/weighted scatterplot smoothing”)</p>
<p>In the curves above, the smoothed line has difficulties following the steep decent in the middle. This is because a kernel smoother cannot “sense slope”.</p>
<p>Before, we have calculated a weighted average to get a smooth <span class="math inline">\(y\)</span> value for a given point <span class="math inline">\(x_0\)</span>. Now, we will perform a weighted regression at this point.</p>
<p>Let’s choose <span class="math inline">\(x_0=0.4\)</span> and look at the weights by making a scatter plot<br>
using points with weight-proportional area:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-9_f0a399a30e8e25b8cbd370c32effe9e7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> .<span class="dv">4</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> .<span class="dv">1</span> )</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y, <span class="at">cex=</span>w )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s fit a regression in line into with plot. We use the fact that the <code>lm</code> function accepts weights.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-10_5917ec2b943f776baea0562ccd8bba02">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>( y <span class="sc">~</span> x, <span class="at">weights=</span>w )</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x, weights = w)

Coefficients:
(Intercept)            x  
      4.201       -9.521  </code></pre>
</div>
</div>
<p>Here, <code>lm</code> has now maximized the weighted sum of squared residuals,</p>
<p><span class="math display">\[ \frac{\sum_i w_i ( \hat y_i - y )^2}{\sum_i w_i}, \qquad \text{with } \hat y_i = \hat a + \hat b x_i, \]</span> where <span class="math inline">\(\hat a\)</span> and <span class="math inline">\(\hat b\)</span> are the fitetd coefficients (intercept and slope), reported by</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-11_25dd008e064c225699571e09d8ae43be">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)           x 
   4.200663   -9.521193 </code></pre>
</div>
</div>
<p>and <span class="math inline">\(w_i\)</span> are the weights, calculated as above.</p>
<p>Let’s put the regression line into our plot, in orange, together fith the fitted value at point <span class="math inline">\(x_0\)</span> (in red) :</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-12_dd381b271e7e3c339efd8e3071084c79">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y, <span class="at">cex=</span>w )</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>( <span class="at">a=</span><span class="fu">coef</span>(fit)[<span class="dv">1</span>], <span class="at">b=</span><span class="fu">coef</span>(fit)[<span class="dv">2</span>], <span class="at">col=</span><span class="st">"orange"</span> )</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>( x0, <span class="fu">coef</span>(fit)[<span class="dv">1</span>] <span class="sc">+</span> x0<span class="sc">*</span><span class="fu">coef</span>(fit)[<span class="dv">2</span>], <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>(xg), <span class="at">col=</span><span class="st">"lightblue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here is a function that does all these steps:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-13_5347c3ac39784df66549b112a7407f33">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>local_regression_smooth <span class="ot">&lt;-</span> <span class="cf">function</span>( x0, x, y, h ) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> h )</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>( y <span class="sc">~</span> x, <span class="at">weights=</span>w )</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(fit)[<span class="dv">1</span>] <span class="sc">+</span> x0 <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s not vectorized, so we have to wrap it in an <code>sapply</code> to get the whole smoothed curve (as before):</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-14_c3813c84169f78abb93872e462c20d53">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  xg, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>( xg, local_regression_smooth, x, y, <span class="at">h=</span>.<span class="dv">1</span>), </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">ylim=</span><span class="fu">c</span>( <span class="sc">-</span>.<span class="dv">1</span>, <span class="fl">1.5</span> ) )</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here, switching from simple kernel smoothing to local regression did not make that much of a difference but sometimes, it helps a lot.</p>
<section id="higher-order-local-regression" class="level4">
<h4 class="anchored" data-anchor-id="higher-order-local-regression">Higher-order local regression</h4>
<p>Of course, instead of fitting a regression line, we could have fitted a parabola. This is quickly done, by adding a quadratic term to the regression</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-15_840471d230be3b99c50a3122406ead59">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>local_quadratic_regression_smooth <span class="ot">&lt;-</span> <span class="cf">function</span>( x0, x, y, h ) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> h )</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>( y <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(x<span class="sc">^</span><span class="dv">2</span>), <span class="at">weights=</span>w )</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(fit)[<span class="dv">1</span>] <span class="sc">+</span> x0 <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>] <span class="sc">+</span> x0<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">3</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-16_da85c3833c0a8d214123dad674d76218">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  xg, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>( xg, local_quadratic_regression_smooth, x, y, <span class="at">h=</span>.<span class="dv">1</span>), </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">ylim=</span><span class="fu">c</span>( <span class="sc">-</span>.<span class="dv">1</span>, <span class="fl">1.5</span> ) )</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This did, in fact, improve the fit.</p>
</section>
<section id="adaptive-bandwidth" class="level4">
<h4 class="anchored" data-anchor-id="adaptive-bandwidth">Adaptive bandwidth</h4>
<p>What if the x values are not uniformly dstributed?</p>
<p>This time, we draw our x values from a non-uniform distribution:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-17_7e2d7cd3ab9bc93fe896e5f9bfbbde70">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">13245768</span> )</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sample</span>( <span class="fu">c</span>( <span class="fu">rbeta</span>( n<span class="sc">/</span><span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">7</span> ), <span class="fu">rbeta</span>( n<span class="sc">/</span><span class="dv">2</span>, <span class="dv">9</span>, <span class="dv">1</span> ) ) )</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">true_function</span>( x ) <span class="sc">+</span> <span class="fu">rnorm</span>( n, <span class="at">sd=</span>.<span class="dv">1</span> )</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y )</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">sapply</span>( xg, local_quadratic_regression_smooth, x, y, <span class="at">h=</span>.<span class="dv">1</span> ), <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The bandwidth is too large where the points are dense and too narrow where they are sparse.</p>
<p>Adaptive bandwidth: Always choose <span class="math inline">\(h\)</span> such that a fixed number of x values are within the kernel window.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-18_ea71d589d62ac52905832be2befb3df0">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>local_quadratic_regression_adaptive_smooth <span class="ot">&lt;-</span> <span class="cf">function</span>( x0, x, y, hn ) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  ds <span class="ot">&lt;-</span> <span class="fu">sort</span>( <span class="fu">abs</span>( x <span class="sc">-</span> x0 ) )</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> ds[hn]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> h )</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>( y <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(x<span class="sc">^</span><span class="dv">2</span>), <span class="at">weights=</span>w )</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(fit)[<span class="dv">1</span>] <span class="sc">+</span> x0 <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>] <span class="sc">+</span> x0<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">3</span>]</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y )</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">sapply</span>( xg, local_quadratic_regression_adaptive_smooth, x, y, <span class="at">hn=</span><span class="dv">30</span> ), <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="locfit" class="level4">
<h4 class="anchored" data-anchor-id="locfit">Locfit</h4>
<p>In R, all this, and more, is available via the <code>loess</code> function (part of base R) or the <code>locfit</code> package. Our implementation above is, of course, very simple and slow, so better use these functions.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-19_aa9063e206fecfbdf13053c2e6574dac">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y )</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">sapply</span>( xg, local_quadratic_regression_adaptive_smooth, x, y, <span class="at">hn=</span><span class="dv">30</span> ), <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">loess</span>( y <span class="sc">~</span> x, <span class="at">degree=</span><span class="dv">2</span>, <span class="at">span =</span> <span class="dv">30</span><span class="sc">/</span><span class="fu">length</span>(x) )</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">predict</span>( fit, xg ), <span class="at">col=</span><span class="st">"orange"</span>, <span class="at">lty=</span><span class="st">"dashed"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here, we specified in the <code>loess</code> call that we want local regression with quadratic polynomials, with an adaptive bandwidth as given by <code>span</code> (which specified the number of points put under the kernel as fraction of the total number of data points).</p>
<p>It seems that the “loess” function gives a slightly better result than our simple implementation. Maybe it knows an additional trick?</p>
</section>
</section>
<section id="uncertainty-estimation" class="level3">
<h3 class="anchored" data-anchor-id="uncertainty-estimation">Uncertainty estimation</h3>
<section id="bootstrapping" class="level4">
<h4 class="anchored" data-anchor-id="bootstrapping">Bootstrapping</h4>
<p>Usually, we do not know the “true” function. So, how can we judge how good it is?</p>
<p>Bootstrapping offers a way.</p>
<p>Bootstrapping means to replace the data with new data which is obtained by drawing observations, i.e., <span class="math inline">\((x,y)\)</span> pairs, from the data, with replacement. Doing this many times provides a distribution of possible alternative fits.</p>
<p>First, let’s do this for simple kernel smoothing:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-20_5d257e7b3a3269e4c569add3233a304f">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">2</span>,<span class="fl">1.6</span>) )</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span> ) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  bss <span class="ot">&lt;-</span> <span class="fu">sample.int</span>( <span class="fu">length</span>(x), <span class="at">replace=</span><span class="cn">TRUE</span> )</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>( xg, <span class="fu">sapply</span>( xg, kernel_smooth, x[bss], y[bss], <span class="at">h=</span>.<span class="dv">1</span> ), </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>( <span class="st">"red"</span>, <span class="at">alpha=</span>.<span class="dv">1</span> ) ) }</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>(xg), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now the same for local quadratic regression with the <code>loess</code> function:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-21_f1d6036d7eadd82df6bd973609d2917f">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>,<span class="fl">1.5</span>) )</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span> ) {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  bss <span class="ot">&lt;-</span> <span class="fu">sample.int</span>( <span class="fu">length</span>(x), <span class="at">replace=</span><span class="cn">TRUE</span> )</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>( xg, <span class="fu">predict</span>( <span class="fu">loess</span>( y[bss] <span class="sc">~</span> x[bss], <span class="at">degree=</span><span class="dv">2</span>, <span class="at">span =</span> <span class="dv">30</span><span class="sc">/</span><span class="fu">length</span>(x) ), xg ),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>( <span class="st">"red"</span>, <span class="at">alpha=</span>.<span class="dv">1</span> ) ) }</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>(xg), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="leave-one-out-cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="leave-one-out-cross-validation">Leave-one-out cross-validation</h4>
<p>Another possibility is to use LOO-CV:</p>
<p>Calculate for each data point its y value, using the y values of its neighbours, but not using the point’s own y value.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-22_7393e2676e4257d9b56b2a3ee4793abe">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>yhat_loo <span class="ot">&lt;-</span> <span class="fu">sapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x), <span class="cf">function</span>(i)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kernel_smooth</span>( x[i], x[<span class="sc">-</span>i], y[<span class="sc">-</span>i], <span class="at">h=</span>.<span class="dv">1</span> ) ) </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y )</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>( x, yhat_loo, <span class="at">col=</span><span class="st">"red"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we can calculate a mean squared error (MSE):</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-23_1e04eb14393ea2c2881ffd806268f747">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>( ( y <span class="sc">-</span> yhat_loo )<span class="sc">^</span><span class="dv">2</span> )  <span class="co"># Mean squared error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01629228</code></pre>
</div>
</div>
<p>Is the MSE lower with a more advanced smoother?</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-24_8a2b70fcf48f0e0c04fd32dfa20adf30">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>yhat_loo <span class="ot">&lt;-</span> <span class="fu">sapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x), <span class="cf">function</span>(i)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>( <span class="fu">loess</span>( y[<span class="sc">-</span>i] <span class="sc">~</span> x[<span class="sc">-</span>i] ), x[i] ) ) </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>( ( y <span class="sc">-</span> yhat_loo )<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08926885</code></pre>
</div>
</div>
</section>
<section id="standard-errors-from-regression" class="level4">
<h4 class="anchored" data-anchor-id="standard-errors-from-regression">Standard errors from regression</h4>
<p>Using the math of ordinary least squares (OLS) regression, we can also get standard errors from a LOESS fit.</p>
<p>Here, we multiply by 1.96 to get a 95% confidence band.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-25_4868abdf474227c1f0ab167ea922c241">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>( <span class="fu">loess</span>( y <span class="sc">~</span> x, <span class="at">span=</span>.<span class="dv">1</span> ), xg, <span class="at">se=</span><span class="cn">TRUE</span> )</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, y, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>,<span class="fl">1.5</span>) )</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, pred<span class="sc">$</span>fit, <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rect</span>( xg, pred<span class="sc">$</span>fit <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> pred<span class="sc">$</span>se.fit, </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lead</span>(xg), pred<span class="sc">$</span>fit <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> pred<span class="sc">$</span>se.fit, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"red"</span>,.<span class="dv">3</span>), <span class="at">lty=</span><span class="st">"blank"</span> )</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_function</span>(xg), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="example-with-poisson-noise" class="level3">
<h3 class="anchored" data-anchor-id="example-with-poisson-noise">Example with Poisson noise</h3>
<p>Above, the noise was Gaussian (normal). In our single-cell data, it is Poissonian. Furthermore, we would like to calculate the curve on the log level, while properly dealing with zeroes.</p>
<p>We construct example count data from our curved function.</p>
<p>Let’s use a few more data points this time:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-26_57bb294c1d103c516555a98ab4bde7c7">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">300</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s sample predictors. We call them x, as before, even though t might be appropriate, too, as in out real-data example, the x axis was pseudotime.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-27_90648ea1f8def3376432707c935c7d7f">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">13245768</span> )</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we need cell sizes (count totals per cell). We draw them from a log normal:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-28_eb9f068c3e72d737fcdf9e97d273ac9a">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> <span class="fu">round</span>( <span class="fu">exp</span>( <span class="fu">rnorm</span>( n, <span class="fu">log</span>(<span class="fl">1e3</span>), .<span class="dv">5</span> ) ) )</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( <span class="fu">log10</span>(s) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Next, we get true fractions from our <code>true_function</code>, which we exponentiate. We have to rescale and shift a bit to get realistic values:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-29_9bfee95d1ad52c71b3254b888cac6ef0">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>true_fraction <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">exp</span>( <span class="fu">true_function</span>(x) <span class="sc">*</span> <span class="dv">4</span> <span class="sc">-</span> <span class="dv">8</span> )</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">true_fraction</span>(x)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, q, <span class="at">log=</span><span class="st">"y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, we add the Poisson noise:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-30_21c3246077e340f5fd1840925f9c1524">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">rpois</span>( n, q <span class="sc">*</span> s )</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, <span class="fu">log</span>( k<span class="sc">/</span>s <span class="sc">*</span> <span class="fl">1e4</span> <span class="sc">+</span> <span class="dv">1</span> ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="kernel-smoothing-1" class="level3">
<h3 class="anchored" data-anchor-id="kernel-smoothing-1">Kernel smoothing</h3>
<p>Let’s first use a simple kernel smoother. However, for the average, we use this time not <span class="math display">\[ f_\text{sm}(x_0) = \frac{ \sum_i y_i w_i }{\sum_i w_i}, \]</span> as before, but <span class="math display">\[ f_\text{Psm}(x_0) = \log \frac{ \sum_i k_i w_i }{\sum_i s_i w_i}, \]</span> We first try it, then see why this makes sense.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-31_cd753be673d5367794ecebfdfd878e48">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>kernel_smooth_Poisson <span class="ot">&lt;-</span> <span class="cf">function</span>( x0, x, k, s, h ) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> h )</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>( w <span class="sc">*</span> k ) <span class="sc">/</span> <span class="fu">sum</span>( w <span class="sc">*</span> s )</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use it to draw a smoothed plot:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-32_22fd36c79b707cdfcd9d8939dbde547e">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>xg <span class="ot">&lt;-</span> <span class="fu">seq</span>( <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">300</span> )</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( xg, <span class="fu">sapply</span>( xg, kernel_smooth_Poisson, x, k, s, <span class="at">h=</span>.<span class="dv">1</span> ), </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">log=</span><span class="st">"y"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">1e-4</span>,<span class="fl">1e-1</span>) )</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">true_fraction</span>( xg ), <span class="at">col=</span><span class="st">"blue"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To understand the change in the last two equations, we need a short detour:</p>
<section id="inverse-variance-weighting" class="level4">
<h4 class="anchored" data-anchor-id="inverse-variance-weighting">Inverse-variance weighting</h4>
<p>Given <span class="math inline">\(n\)</span> independent random variables <span class="math inline">\(X_i\)</span> with variances <span class="math inline">\(v_i=\operatorname{v_i}\)</span>, we want to estimate the expectation of their mean, <span class="math inline">\(\operatorname{E}\left(\frac{1}{n}\sum_{i=1}^n X_i\right)\)</span>, by way of estimating a weighted mean, <span class="math display">\[ \hat\mu = \frac{\sum_iw_iX_i}{\sum_i w_i}. \]</span> How should the weights be chosen such that the estimator’s sampling variance, <span class="math inline">\(\operatorname{Var}\hat\mu\)</span>, is minimized?</p>
<p>If all the estimated variances are the same, <span class="math inline">\(v_i=v\)</span>, then the weights should all be the same, too: <span class="math inline">\(w_i\propto 1\)</span>.</p>
<p>In general, however, the weights might differ. Then, one should choose <span class="math inline">\(\w_i\propto \frac{1}{v_i}\)</span>.</p>
<p>This is easily proven with Lagrange multipliers; the proof can be found on the Wikipedia page on <a href="https://en.wikipedia.org/wiki/Inverse-variance_weighting">inverse-variance weighting</a>.</p>
</section>
<section id="application-to-poisson-variables" class="level4">
<h4 class="anchored" data-anchor-id="application-to-poisson-variables">Application to Poisson variables</h4>
<p>Let us now assume that the random variables we want to average over are fractions derived from Poisson counts. We have cells, indexed by <span class="math inline">\(i\)</span>, with counts for our gene of interest, given by <span class="math inline">\(K_i\sim \operatorname{Pois}(s_i q)\)</span>, where <span class="math inline">\(s_i\)</span> is the “size”, i.e., the total count sum for the cell. We wish to estimate the common expected fraction <span class="math inline">\(q\)</span> via teh weighted average <span class="math display">\[ \hat q = \frac{\sum_iw_i\frac{K_i}{s_i}}{\sum_i w_i}. \]</span> What weights <span class="math inline">\(w_i\)</span> should we use? Using <span class="math inline">\(\operatorname{Var} K_i=s_i q\)</span> together with the preceding result, we get <span class="math display">\[ w_i \propto \frac{1}{\operatorname{Var}\frac{K_i}{s_i}}=\frac{1}{\frac{1}{s_i^2}\operatorname{Var}K_i}=\frac{1}{\frac{1}{s_i^2}s_iq}=\frac{s_i}{q} \propto s_i \]</span> Hence:</p>
<p><span class="math display">\[ \hat q = \frac{\sum_iw_i\frac{K_i}{s_i}}{\sum_i w_i} = \frac{\sum_i s_i\frac{K_i}{s_i}}{\sum_i s_i} = \frac{\sum_i K_i}{\sum_i s_i}. \]</span> This justifies our switching from <span class="math inline">\(\frac{1}{n}\sum_i(k_i/s_i)\)</span> to <span class="math inline">\((\sum_i k_i)/(\sum_i s_i)\)</span> in our smoothing function.</p>
</section>
</section>
<section id="generalized-linear-models" class="level3">
<h3 class="anchored" data-anchor-id="generalized-linear-models">Generalized linear models</h3>
<p>Before proceding further, we need another detour, this time to introduce generalized linear models (GLMs) as a generalization of OLS linear models.</p>
<section id="example-radioactive-decay" class="level4">
<h4 class="anchored" data-anchor-id="example-radioactive-decay">Example: Radioactive decay</h4>
<p>We have measurements of the number of clicks per minute for a radioactive sample. Let’s simulate this: We count every 10 minutes for 1 minute, up to 200 minutes. The activite at t=0 is 1000 clicks/min, the half-life is 130 min.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-33_ae875b1cc63730f96867f58ada24a2c8">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">seq</span>( <span class="at">from=</span><span class="dv">0</span>, <span class="at">by=</span><span class="dv">10</span>, <span class="at">length.out=</span><span class="dv">20</span> )</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>expected_counts_per_min <span class="ot">&lt;-</span> <span class="dv">100</span><span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span>( <span class="sc">-</span> t <span class="sc">/</span> <span class="dv">20</span> )</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">rpois</span>( <span class="fu">length</span>(t), expected_counts_per_min )</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( t, k )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A simple approach is to plot on a semi-log plot:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-34_da7faee1adbc2d3cc2d109d2f71c7c59">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( t, k, <span class="at">log=</span><span class="st">"y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in xy.coords(x, y, xlabel, ylabel, log): 6 y values &lt;= 0 omitted from
logarithmic plot</code></pre>
</div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and fit a regression line. However, the zeroes mess this up.</p>
<p>Here’s a better way:</p>
<p>We may assume that <span class="math display">\[ k_i \sim \operatorname{Pois}( \alpha e^{\kappa t_i})\]</span> The true values are <span class="math inline">\(\alpha = 100\)</span> (the initial click rate) and <span class="math inline">\(\kappa = \ln 2 / 20\approx .035\)</span> (using the half life, 20, from above).</p>
<p>We can find maximum-likelihood estimates for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\kappa\)</span>. Here is the log-likelihood for a pair of candidate values <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(kappa\)</span>:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-35_56aabaa37260d5e9ab1bb07e42385910">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> <span class="cf">function</span>( alpha, kappa )</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>( <span class="fu">dpois</span>( k, alpha <span class="sc">*</span> <span class="fu">exp</span>( <span class="sc">-</span>kappa <span class="sc">*</span> t ), <span class="at">log=</span><span class="cn">TRUE</span> ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can find the parameters that maximize this function, using some guessed initital values:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-36_738151ef25720520db02854630ae3ea7">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">optim</span>( </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>( <span class="dv">50</span>, <span class="fl">0.1</span> ),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>( x ) <span class="sc">-</span><span class="fu">ll</span>( x[<span class="dv">1</span>], x[<span class="dv">2</span>] ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 92.39194421  0.03427986

$value
[1] 40.2579

$counts
function gradient 
     117       NA 

$convergence
[1] 0

$message
NULL</code></pre>
</div>
</div>
</section>
<section id="glms" class="level4">
<h4 class="anchored" data-anchor-id="glms">GLMs</h4>
<p>Rewriting our model a bit, we recover the form of a “generalized linear model” (GLM). A GLM always has three components:</p>
<ol type="i">
<li>The response (in our case, the counts <span class="math inline">\(K_i\)</span>) follows a distribution from the so-called exponential family (which includes the normal, the Poisson, the binomial, the gamma-Poisson, and others). Here, we have:</li>
</ol>
<p><span class="math display">\[ K_i \sim \operatorname{Pois}( \mu_i ). \]</span> (ii) The mean parameter <span class="math inline">\(\mu_i\)</span> in that distribution is coupled with teh so-called “linear predictir$ _i$ by a function, the so-called “link function”. Here: <span class="math display">\[ \eta_i = \log \mu_i. \]</span> (iii) The linear predictor is a linear combination of known predictors <span class="math inline">\(x_ij\)</span> with unknown coefficients <span class="math inline">\(\beta_j\)</span>. In general <span class="math display">\[ \eta_i = \beta_0 + \sum_j \beta_j x_{ij} + o_i\]</span> and here simply <span class="math display">\[ \eta_i = \beta_0 + \beta_1 t_i, \]</span> i.e.&nbsp;we have, besides the intercept <span class="math inline">\(\beta_0\)</span>, only one further coefficient, <span class="math inline">\(\beta_1\)</span>.</p>
<p>There are also no offsets <span class="math inline">\(o_i\)</span>. (If the time we had waited at each time point to count would not always have been the same but differed from measurement to measurement, we would have included the length these waiting times as “exposure values” <span class="math inline">\(o_i\)</span>.)</p>
<p>We can clearly identify how the coefficients of the GLM correspond to our parameters: <span class="math inline">\(\beta_1=-\kappa=-\ln2/T_{1/2}\)</span> and <span class="math inline">\(\beta_0=\ln\alpha\)</span>.</p>
<p>If the model has this shape, the general optimizer <code>optim</code> that we have used above can be replaced by a GLM solver:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-37_e6e156a78f02b62602242d60a540b0ac">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>( k <span class="sc">~</span> t, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link=</span><span class="st">"log"</span>) )</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = k ~ t, family = poisson(link = "log"))

Coefficients:
(Intercept)            t  
    4.52600     -0.03428  

Degrees of Freedom: 19 Total (i.e. Null);  18 Residual
Null Deviance:      612.2 
Residual Deviance: 21.62    AIC: 84.52</code></pre>
</div>
</div>
<p>We get the same result as with optim. We see this directly for the coefficient for <span class="math inline">\(t\)</span> (i.e., <span class="math inline">\(\kappa\)</span>), but for <span class="math inline">\(\alpha\)</span>, we have to exponentiate:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-38_ba76fc80672716c375017658d898629c">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   92.38863 </code></pre>
</div>
</div>
</section>
<section id="irls" class="level4">
<h4 class="anchored" data-anchor-id="irls">IRLS</h4>
<p>The <code>glm</code> function is faster than <code>optim</code> and more stable, because it uses a special algorithm known as “iteratively reweighted least squares” (IRLS) fitting.</p>
<p>I was too lazy to write up how this works, so I asked ChatGPT to do my work:</p>
<p>https://chatgpt.com/share/38554552-182e-45cf-9ea9-556a3592d6df</p>
</section>
</section>
<section id="local-regression-with-glms" class="level3">
<h3 class="anchored" data-anchor-id="local-regression-with-glms">Local regression with GLMs</h3>
<p>Now, that we know GLMs, we can come back to our count data to be smoothed:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-39_96a7ece8b28b3dd10381c9a46f2e830e">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">13245768</span> )</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">round</span>( <span class="fu">exp</span>( <span class="fu">rnorm</span>( n, <span class="fu">log</span>(<span class="fl">1e3</span>), .<span class="dv">5</span> ) ) )</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">rpois</span>( n, q <span class="sc">*</span> s )</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, <span class="fu">log</span>( k<span class="sc">/</span>s <span class="sc">*</span> <span class="fl">1e4</span> <span class="sc">+</span> <span class="dv">1</span> ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Instead of a simple kernel smoother, let’s to local regression again, but now with the <code>glm</code> function instead of the <code>lm</code> function:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-40_0246febec0e1b2a60543c3ced4ae6ee6">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>local_quadratic_regression_smooth_Poisson <span class="ot">&lt;-</span> <span class="cf">function</span>( x0, x, k, s, h ) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">tricube</span>( ( x <span class="sc">-</span> x0 ) <span class="sc">/</span> h )</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">glm</span>( k <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(x<span class="sc">^</span><span class="dv">2</span>), <span class="at">weights=</span>w, <span class="at">offset=</span><span class="fu">log</span>(s), <span class="at">family=</span><span class="fu">poisson</span>(<span class="st">"log"</span>) )</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>( <span class="fu">coef</span>(fit)[<span class="dv">1</span>] <span class="sc">+</span> x0 <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>] <span class="sc">+</span> x0<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">coef</span>(fit)[<span class="dv">3</span>] )</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Can you see why we pass the totals <span class="math inline">\(s\)</span> as offsets? Why logarithmized? Have a careful look at the formula with <span class="math inline">\(o_i\)</span> above.</p>
<p>Here is the result. Smoothed curve in red, noisy data in gray, original function in blue.</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-41_0f0adb1fc04c8fa1b222ed4113593365">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  yhat <span class="ot">&lt;-</span> <span class="fu">sapply</span>( xg, local_quadratic_regression_smooth_Poisson, x, k, s, .<span class="dv">15</span> ) )</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, <span class="fu">log</span>( k<span class="sc">/</span>s <span class="sc">+</span> <span class="fl">1e-4</span> ), <span class="at">col=</span><span class="st">"gray"</span> )</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, yhat, <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">log</span>( <span class="fu">true_fraction</span>( xg ) ), <span class="at">col=</span><span class="st">"blue"</span> ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We get a lot of warnings aboutv failure of IRLS to converge for some values.</p>
<p>Instead of trying to debug this, we use the locfit package, where we have a ready-made function for this purpose:</p>
<div class="cell" data-hash="smoothing_cache/html/unnamed-chunk-42_3fcd1e8fb0219487d4270d503ddf7941">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( locfit )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>locfit 1.5-9.9   2024-03-01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'locfit'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    none</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">locfit</span>( k <span class="sc">~</span> <span class="fu">lp</span>( x, <span class="at">h=</span>.<span class="dv">15</span>), <span class="at">weights=</span>s, <span class="at">family=</span><span class="st">"poisson"</span> )</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x, <span class="fu">log</span>( k<span class="sc">/</span>s <span class="sc">+</span> <span class="fl">1e-4</span> ), <span class="at">col=</span><span class="st">"gray"</span> )</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">log</span>( <span class="fu">predict</span>( fit, xg ) ), <span class="at">col=</span><span class="st">"red"</span> )</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>( xg, <span class="fu">log</span>( <span class="fu">true_fraction</span>( xg ) ), <span class="at">col=</span><span class="st">"blue"</span> ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="smoothing_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="spline-smoothing" class="level3">
<h3 class="anchored" data-anchor-id="spline-smoothing">Spline smoothing</h3>
<p>[to be added]</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>