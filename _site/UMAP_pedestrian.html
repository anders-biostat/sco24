<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mathematics of single-cell omics - UMAP for pedestrians</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">UMAP for pedestrians</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Here, we reimplement UMAP</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.sparse</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> colormaps</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tnrange, tqdm</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> umap</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> igraph</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> leidenalg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/anders/pyenv_torch/lib/python3.11/site-packages/umap/distances.py:1063: NumbaDeprecationWarning: The 'nopython' keyword argument was not supplied to the 'numba.jit' decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.
  @numba.jit()
/home/anders/pyenv_torch/lib/python3.11/site-packages/umap/distances.py:1071: NumbaDeprecationWarning: The 'nopython' keyword argument was not supplied to the 'numba.jit' decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.
  @numba.jit()
/home/anders/pyenv_torch/lib/python3.11/site-packages/umap/distances.py:1086: NumbaDeprecationWarning: The 'nopython' keyword argument was not supplied to the 'numba.jit' decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.
  @numba.jit()
/home/anders/pyenv_torch/lib/python3.11/site-packages/umap/umap_.py:660: NumbaDeprecationWarning: The 'nopython' keyword argument was not supplied to the 'numba.jit' decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.
  @numba.jit()</code></pre>
</div>
</div>
<section id="example-data" class="level3">
<h3 class="anchored" data-anchor-id="example-data">Example data</h3>
<p>We use again the IFNAGRKO dataset. Log-normalization and PCA has already been performed.</p>
<p>Here is the result of the PCA:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> h5py.File(<span class="st">"../ifnagrko_pca.h5"</span>) <span class="im">as</span> f:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    pca <span class="op">=</span> f[<span class="st">'pca'</span>][:].transpose()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>ncells <span class="op">=</span> pca.shape[<span class="dv">0</span>]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>pca[:<span class="dv">5</span>,:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>array([[ 16.28623584, -12.28097802,  -5.47207594, -21.76252769,
         -1.77129431],
       [-10.83887971,   0.33993333,   2.08093385,   0.69148338,
         -7.08986989],
       [ 12.58293331,   7.58620352,  -1.90409793,   7.65700522,
          3.03268977],
       [ 10.06454811,   6.13142251,  -2.11701715,   4.04206773,
          2.279775  ],
       [-10.0199706 ,  -0.89696176,   6.20651074,  -0.53720203,
         -6.59578868]])</code></pre>
</div>
</div>
</section>
<section id="standard-umap" class="level3">
<h3 class="anchored" data-anchor-id="standard-umap">Standard UMAP</h3>
<p>We use the UMAP package to perform the transformation.</p>
<p>Note that we stick to default values except for one thing: We have fixed the hyperparameters <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> both to 1.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ump0 <span class="op">=</span> umap.UMAP( a<span class="op">=</span><span class="dv">1</span>, b<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span> ).fit( pca )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>UMAP(a=1, b=1, verbose=True)
Mon Jun 24 12:15:13 2024 Construct fuzzy simplicial set
Mon Jun 24 12:15:13 2024 Finding Nearest Neighbors
Mon Jun 24 12:15:13 2024 Building RP forest with 12 trees
Mon Jun 24 12:15:18 2024 NN descent for 14 iterations
     1  /  14
     2  /  14
     3  /  14
     4  /  14
    Stopping threshold met -- exiting after 4 iterations
Mon Jun 24 12:15:36 2024 Finished Nearest Neighbor Search
Mon Jun 24 12:15:39 2024 Construct embedding
Mon Jun 24 12:15:51 2024 Finished embedding</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"491815d624494935a8eb0597b2a90d63","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Here’s a scatter plot of the result</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plt.scatter( ump0.embedding_[:,<span class="dv">0</span>], ump0.embedding_[:,<span class="dv">1</span>], s<span class="op">=</span><span class="fl">.1</span> )</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plt.gca().set_aspect(<span class="st">'equal'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p><em>Next, we will recreate this “on foot”.</em></p>
</section>
<section id="find-nearest-neighbors" class="level3">
<h3 class="anchored" data-anchor-id="find-nearest-neighbors">Find nearest-neighbors</h3>
<p>We use a <a href="https://en.wikipedia.org/wiki/K-d_tree">kd tree</a> to find the 15 nearest neighbors:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nnbgs <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>nndist, nnidx <span class="op">=</span> scipy.spatial.KDTree( pca ).query( pca, k<span class="op">=</span>nnbgs<span class="op">+</span><span class="dv">1</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>nnidx</code> is now an array of shape <code>ncells</code> by <code>nnbgs+1</code>, giving for each cell the indices of its nearest neighbours:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>nnidx[:<span class="dv">5</span>,:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([[    0,  2503,  4612,  2816,  2696],
       [    1, 12411, 11119,  9816,  6432],
       [    2, 10072,  9511,  3942,  7029],
       [    3, 12406,  2607, 16033,  8034],
       [    4, 10059, 10134,  3873,  5332]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>nndist[:<span class="dv">5</span>,:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>array([[0.        , 2.91554959, 3.87197945, 3.94469136, 4.04883681],
       [0.        , 1.74307066, 1.8722435 , 1.90254414, 1.94840715],
       [0.        , 2.3056303 , 2.36507558, 2.40163638, 2.56152625],
       [0.        , 2.21332819, 2.88892446, 2.91914098, 2.93972125],
       [0.        , 2.8192931 , 3.05565062, 3.12995438, 3.15387043]])</code></pre>
</div>
</div>
<p>As each cell is listed as its own nearest neighbor, we remove the first column, leaving us with <code>nnbgs</code> columns.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>nnidx <span class="op">=</span> nnidx[:,<span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The array <code>nndist</code> contains the distances of the neighbours to the respective cell. The array has the same shape. We also remove the first column.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>nndist <span class="op">=</span> nndist[:,<span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="similarity-score" class="level3">
<h3 class="anchored" data-anchor-id="similarity-score">Similarity score</h3>
<p>The UMAP algorithm suggests to convert these distances (we write <span class="math inline">\(d_{ij}\)</span> for the distance from cerll <span class="math inline">\(i\)</span> to cell <span class="math inline">\(j\)</span>) into similarity scores <span class="math inline">\(\mu_{ij}\)</span> using an exponential: For the similarity of a cell <span class="math inline">\(i\)</span> to another cell <span class="math inline">\(j\)</span> that is among its <span class="math inline">\(k\)</span> nearest neighbors, we set <span class="math display">\[\mu_{i\rightarrow j} = a_i e^{-d_{ij}/\sigma_i}.\]</span> The similarity score of cell <span class="math inline">\(i\)</span> to any cell further away is set to 0.</p>
<p>The UMAP paper argues that the metric in the high-dimensional space should be locally re-adjusted such that the point density becomes roughly uniform, because only then does the algorithm’s theoretical justification hold.</p>
<p>They suggest to set <span class="math inline">\(a_i=e^{d_{ii_1}/\sigma_i}\)</span>, where <span class="math inline">\(d_{ii_1}\)</span> is the distance of cell <span class="math inline">\(i\)</span> to its nearest neighbor. This means that the similarity score from any cell to its nearest neighbor is 1: <span class="math display">\[\mu_{i\rightarrow j} =e^{-(d_{ij}-d_{i,i_1})/\sigma_i}.\]</span></p>
<p>Furthermore, the decay constant <span class="math inline">\(\sigma_i\)</span> is chosen such that <span class="math display">\[\sum_{j=1}^k \mu_{i\rightarrow j} = \log_2 k,\]</span> where <span class="math inline">\(k\)</span> is the numebr of nearest neighbors.</p>
<p>Note that these values are not symmetric under exchange of <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>. We therefore call these numbers the “directed” similarity scores.</p>
<p>To calculate them, we find the decay constants <span class="math inline">\(\sigma_i\)</span> using a simple root-finding approach:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mu_dir <span class="op">=</span> np.zeros_like( nndist )</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(mu_dir.shape[<span class="dv">0</span>]):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> scipy.optimize.root( </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> sigma: np.exp( <span class="op">-</span>( nndist[i,:] <span class="op">-</span> nndist[i,<span class="dv">0</span>] ) <span class="op">/</span> sigma ).<span class="bu">sum</span>() <span class="op">-</span> math.log2(nnbgs<span class="op">+</span><span class="dv">1</span>), </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        nndist[i,<span class="dv">1</span>]<span class="op">-</span>nndist[i,<span class="dv">0</span>] )</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.success</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    mu_dir[i,:] <span class="op">=</span> np.exp( <span class="op">-</span>( nndist[i,:] <span class="op">-</span> nndist[i,<span class="dv">0</span>] ) <span class="op">/</span> res.x )</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>mu_dir[:<span class="dv">5</span>,:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>array([[1.        , 0.38127649, 0.35432688, 0.31901082, 0.22263436],
       [1.        , 0.4790331 , 0.40307648, 0.31038503, 0.24439773],
       [1.        , 0.78010108, 0.66960721, 0.34335116, 0.21518077],
       [1.        , 0.34741612, 0.33137074, 0.3208687 , 0.25827415],
       [1.        , 0.47652488, 0.37747247, 0.35019673, 0.34993508]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>( np.<span class="bu">abs</span>( mu_dir.<span class="bu">sum</span>(<span class="dv">1</span>) <span class="op">-</span> math.log2(nnbgs<span class="op">+</span><span class="dv">1</span>) ).<span class="bu">max</span>(),</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  np.<span class="bu">abs</span>( mu_dir[:,<span class="dv">0</span>] <span class="op">-</span> <span class="fl">1.</span> ).<span class="bu">max</span>() )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>(8.72191208145523e-13, 0.0)</code></pre>
</div>
</div>
</section>
<section id="symmetrizing-the-similarity-scores" class="level3">
<h3 class="anchored" data-anchor-id="symmetrizing-the-similarity-scores">Symmetrizing the similarity scores</h3>
<p>The UMAP papers’ author suggest to consider the rows of this matrix as neighborhood fuzzy sets: Each cell gets a neighborhood, which is a fuzzy set, containing the cell’s nearest neighbor with probability one and the next <span class="math inline">\(k-1\)</span> neighbours with a probability that decays exponentially with distance. The union of all these forms a “skeleton” or backbone, building a fuzzy simplical complex that covers the manifold.</p>
<p>For this to make sense, we need a symmetric neighborhood relationship. Therefore, we make the union of the reciprocal fuzzy membership probabilities. Given two events <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> with probabilities <span class="math inline">\(p_A\)</span> and <span class="math inline">\(p_B\)</span>, the probability of at least one of the two happening is <span class="math inline">\(p_A+p_B-p_Ap_B\)</span>.</p>
<p>Therefore, we set <span class="math display">\[ \mu_{ij} = \mu_{i\rightarrow j}+\mu_{j\rightarrow i}- \mu_{i\rightarrow j}\mu_{j\rightarrow i}.\]</span></p>
<p>To calculate this, we first set up a sparse matrix whose entries are given by the <span class="math inline">\(\mu_{i\rightarrow j}\)</span>:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>adj_dir <span class="op">=</span> scipy.sparse.coo_array( (ncells,ncells) )</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nnbgs):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    adj_dir <span class="op">+=</span> scipy.sparse.coo_array( (mu_dir[:,i], (np.arange(ncells), nnidx[:,i]) ), shape<span class="op">=</span>(ncells,ncells) )</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>adj_dir</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>&lt;18302x18302 sparse array of type '&lt;class 'numpy.float64'&gt;'
    with 256228 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>This code works as follows: A sparse matrix in COOrdinate form takes three vectors, provided as <code>(data, (row,col))</code>, that indicate that positions and values of all non-zero matrix entries. The <code>i</code>-the iteration of the for-loop constructs such a matrix for the symmetry score of each cell to its <code>i</code>-th nearest neighbor. Adding up these matrices yields the matrix formed by the <span class="math inline">\(\mu_{i \rightarrow j}\)</span>. We call the matrix <code>adj_dir</code>, because it can be understood as the adjacency matrix of a weighted directed nearest-neighbours graph.</p>
<p>The values <span class="math inline">\(\mu_{j \rightarrow i}\)</span> are the matrix elements of the transpsoe of that matrix. The symmetrization is hence calculated with:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>adj_symm <span class="op">=</span> adj_dir <span class="op">+</span> adj_dir.transpose() <span class="op">-</span> adj_dir.multiply( adj_dir.transpose() )</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>adj_symm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>&lt;18302x18302 sparse array of type '&lt;class 'numpy.float64'&gt;'
    with 379018 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>Note that the <code>multiply</code> method used here performs element-wise multiplication, not matrix multiplication, which is waht we need here.</p>
<section id="histograms" class="level4">
<h4 class="anchored" data-anchor-id="histograms">Histograms</h4>
<p>Here are histograms of the nonzero matrix elements of the directed and the symmetrized similarity-score matrix:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plt.hist( adj_dir.data, <span class="dv">100</span> )<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plt.hist( adj_symm.data, <span class="dv">100</span> )<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="compare-with-umap-packages-graph" class="level3">
<h3 class="anchored" data-anchor-id="compare-with-umap-packages-graph">Compare with UMAP package’s graph</h3>
<p>We compare the weighted, symmetrized adjency matrix that we have just manually generated with one generated by the UMAP software. That one can be found here:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ump0.graph_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>&lt;18302x18302 sparse matrix of type '&lt;class 'numpy.float32'&gt;'
    with 378972 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>Number of edges in our graph, and in theirs?</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>( (adj_symm<span class="op">&gt;</span><span class="dv">0</span>).<span class="bu">sum</span>(),  (ump0.graph_<span class="op">&gt;</span><span class="dv">0</span>).<span class="bu">sum</span>() )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(379018, 378972)</code></pre>
</div>
</div>
<p><strong>TO DO</strong>: There is a discrepancy here. Check the above code and find the mistake.</p>
<p>For how many of the edges does the edge weight differ from the one computed by the UMAP package by more than .01?</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>( np.<span class="bu">abs</span>( adj_symm <span class="op">-</span> ump0.graph_ ) <span class="op">&gt;</span> <span class="fl">.01</span> ).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>3788</code></pre>
</div>
</div>
<p>The matrices seem to nearly agree. However, the seemingly minor differences do mess up something, because the code below produces good results only with the <code>ump0.graph_</code>. I will have to search the mistake.</p>
<p>Until I find it, I replace our matrix with the one from the package:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>adj_symm <span class="op">=</span> scipy.sparse.csr_array( ump0.graph_ )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initialization-for-umap" class="level3">
<h3 class="anchored" data-anchor-id="initialization-for-umap">Initialization for UMAP</h3>
<p>Before we can come to the actual UMAP algorithm, we have to discuss vice/v1”, “action”: “get”, “path”: . This is done via the graph Laplacianb, and teh approach only works for connected graphs. Hence, let’s first check whether our graph is connected:</p>
</section>
<section id="connected-components" class="level3">
<h3 class="anchored" data-anchor-id="connected-components">Connected components</h3>
<p>The symmetrized matrix can also be interpreted as an adjacency matrix of an undirected weighted graph.</p>
<p>If we binarize the matrix, i.e., set all non-zero weights to 1, we get the point cloud’s unweighted <span class="math inline">\(k\)</span>-nearest-neighbors graph.</p>
<p>We ask whether this graph is connected:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ncc, ccidx <span class="op">=</span> scipy.sparse.csgraph.connected_components( adj_symm<span class="op">&gt;</span><span class="dv">0</span> )</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ncc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>3</code></pre>
</div>
</div>
<p>No, it is not. We have two connection components that are not connected with each other.</p>
<p>How many cells fall into each component?</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>np.bincount(ccidx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>array([17820,   137,   345])</code></pre>
</div>
</div>
<p>To make our life easier, we remove that small components and only keep the “main component” (<code>mc</code>), which has index 0.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>adj_mc <span class="op">=</span> adj_symm[ ccidx<span class="op">==</span><span class="dv">0</span>, :][:, ccidx<span class="op">==</span><span class="dv">0</span> ]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>adj_mc.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>(17820, 17820)</code></pre>
</div>
</div>
</section>
<section id="leiden-clustering" class="level3">
<h3 class="anchored" data-anchor-id="leiden-clustering">Leiden clustering</h3>
<p>Merely so that we have a way of colouring our cells in subsequent plots, we perform a Leiden clustering.</p>
<p>To this end, we binarize the adjacency matrix (i.e., set all non-zero entries to 1) and form a graph from that.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>nngraph <span class="op">=</span> igraph.Graph.Adjacency( adj_mc<span class="op">&gt;</span><span class="dv">0</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we run the Leiden algorithm.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>clm <span class="op">=</span> leidenalg.find_partition( nngraph, leidenalg.ModularityVertexPartition ).membership</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we have a vector of cluster memberships. Here, for the first 10 cells:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>clm[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>[10, 1, 15, 4, 0, 2, 3, 0, 5, 0]</code></pre>
</div>
</div>
<p>We can colour the UMAP from before using this:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> plt.colormaps[<span class="st">'tab20'</span>](<span class="bu">range</span>( <span class="bu">max</span>(clm)<span class="op">+</span><span class="dv">1</span> ))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>plt.scatter( ump0.embedding_[ ccidx<span class="op">==</span><span class="dv">0</span>, <span class="dv">0</span> ], ump0.embedding_[ ccidx<span class="op">==</span><span class="dv">0</span>, <span class="dv">1</span> ], s<span class="op">=</span><span class="fl">.1</span>, c<span class="op">=</span>palette[clm] )</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>plt.gca().set_aspect(<span class="st">'equal'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="spectral-clustering" class="level3">
<h3 class="anchored" data-anchor-id="spectral-clustering">Spectral clustering</h3>
<p>We are still not ready to perform the actual UMAP algorithm, because we need an initial configuration. In the UMAP package, this is obtained via spectral clustering, so we do the same here:</p>
<p>We start by constructing the graph Laplacian of our weighted adjacency matrix. To this end, we first get a diagonal matrix D of the degrees of the graph vertices, i.e. <span class="math display">\[D_{ij}=\delta_{ij}\sum_{j'}\mu_{ij'}.\]</span></p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>degdiag <span class="op">=</span> scipy.sparse.diags( adj_symm.<span class="bu">sum</span>(<span class="dv">0</span>) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The standard graph Laplacian is given by <span class="math inline">\(L_0=D-A\)</span>, where <span class="math inline">\(A\)</span> is the adjacency matrix formed by the <span class="math inline">\(\mu_{ij}\)</span>. Spectral clustering, however, works better, if one scales the Laplacian by dividing rows and columns by the square roots of the degrees, obtaining <span class="math display">\[L=D^{-1/2}L_0 D^{-1/2} = I - D^{-1/2} A D^{-1/2}.\]</span></p>
<p>We get this scaled Laplacian,</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>invsqrtdegdiag <span class="op">=</span> scipy.sparse.diags( <span class="dv">1</span> <span class="op">/</span> np.sqrt( adj_mc.<span class="bu">sum</span>(<span class="dv">0</span>) ) )</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>scaled_laplacian <span class="op">=</span> scipy.sparse.identity(adj_mc.shape[<span class="dv">0</span>]) <span class="op">-</span> invsqrtdegdiag <span class="op">*</span> adj_mc <span class="op">*</span> invsqrtdegdiag</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and get its 10 smallest (by magnitude) eigenvalues and their eigenvectors</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>evals, evecs <span class="op">=</span> scipy.sparse.linalg.eigsh( scaled_laplacian, k<span class="op">=</span><span class="dv">10</span>, which<span class="op">=</span><span class="st">'SM'</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the eigenvalues:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>evals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>array([-1.10779340e-09,  4.51068171e-04,  5.63650240e-04,  8.16247925e-04,
        1.12456990e-03,  1.27949653e-03,  2.42148730e-03,  2.75061424e-03,
        4.12631309e-03,  5.92756770e-03])</code></pre>
</div>
</div>
<p>As expected, the lowest eigenvalue is 0. There is only one eigenvalue because our graph is connected. Had we kept the other connection component, we would have obtained a multi-dimensional eigenspace to the zero eigenvalue. This is, why we removed it above – so that we do not have to deal with this issue here.</p>
<p>The eigenvector corresponding to the 0 eigenvalue would be constant for the usncaled Laplacian. Due to the scaling, it is now proportional to the square roots of the vertex degrees:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>plt.scatter( evecs[:,<span class="dv">0</span>], np.sqrt(adj_mc.<span class="bu">sum</span>(<span class="dv">0</span>)), s<span class="op">=</span><span class="fl">.1</span> )</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>plt.gcf().set_size_inches(<span class="dv">2</span>,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>This vector is hence not of interest. The next two eigenvectors, however, are. We plot them here:</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>plt.scatter( evecs[:,<span class="dv">1</span>], evecs[:,<span class="dv">2</span>], s<span class="op">=</span><span class="fl">.1</span>, c<span class="op">=</span>palette[clm] )</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>plt.gca().set_aspect(<span class="st">'equal'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>This is what we will use as initial configuration for the UMAP algorithm.</p>
</section>
<section id="umap" class="level3">
<h3 class="anchored" data-anchor-id="umap">UMAP</h3>
<p>For a description of the UMAP algorithm, see <a href="tsne_umap_math.html">here</a>.</p>
<p>Here is an implementation.</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> squared_distance_2d( v1, v2 ):</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> v2[<span class="dv">0</span>] <span class="op">-</span> v1[<span class="dv">0</span>]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    dy <span class="op">=</span> v2[<span class="dv">1</span>] <span class="op">-</span> v1[<span class="dv">1</span>]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dx<span class="op">*</span>dx <span class="op">+</span> dy<span class="op">*</span>dy</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clip( x ):</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&lt;</span> <span class="op">-</span><span class="fl">4.</span>:</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="fl">4.</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> x <span class="op">&gt;</span> <span class="fl">4.</span>:</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">4.</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span>(parallel<span class="op">=</span><span class="va">True</span>,fastmath<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_epoch( ump, edgefr, edgeto, edgewt, lr ):</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ump.shape[<span class="dv">1</span>] <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>( <span class="st">"Must be 2D embedding"</span> )</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    n_vertices <span class="op">=</span> ump.shape[<span class="dv">0</span>]</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    ump2 <span class="op">=</span> ump.copy()</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> prange(edgefr.shape[<span class="dv">0</span>]):</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.random.rand() <span class="op">&gt;</span> edgewt[i]: </span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Choose edge</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        v1 <span class="op">=</span> edgefr[i]</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        v2 <span class="op">=</span> edgeto[i]</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># squared distance</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> squared_distance_2d( ump[v1,], ump[v2,] )</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># attractive force</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>        grad_coef <span class="op">=</span> <span class="op">-</span><span class="fl">2.</span> <span class="op">/</span> ( d2 <span class="op">+</span> <span class="fl">1.</span> ) <span class="op">*</span> edgewt[i]</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>            grad <span class="op">=</span> grad_coef <span class="op">*</span> ( ump[v1,k] <span class="op">-</span> ump[v2,k] )</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>            grad <span class="op">=</span> clip( grad )</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>            ump2[v1,k] <span class="op">+=</span> lr <span class="op">*</span> grad</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>            ump2[v2,k] <span class="op">-=</span> lr <span class="op">*</span> grad</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Choose 5 rejection partners</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>            v2 <span class="op">=</span> np.random.randint(n_vertices)</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>            d2 <span class="op">=</span> squared_distance_2d( ump[v1,], ump[v2,] )</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>            grad_coef <span class="op">=</span> <span class="fl">2.</span> <span class="op">/</span> ( ( d2 <span class="op">+</span> <span class="fl">1.</span> ) <span class="op">*</span> ( d2 <span class="op">+</span> <span class="fl">.001</span> ) ) <span class="op">*</span> (<span class="dv">1</span><span class="op">-</span>edgewt[i])</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>                grad <span class="op">=</span> grad_coef <span class="op">*</span> ( ump[v1,k] <span class="op">-</span> ump[v2,k] )</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>                grad <span class="op">=</span> clip( grad )</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>                ump2[v1,k] <span class="op">+=</span> lr <span class="op">*</span> grad <span class="op">*</span> <span class="fl">.1</span>   <span class="co"># &lt;- strangly low gamma here</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ump2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>run_epoch</code> goes once through all points. It expects a current UMAP configuration (as 2D array with 2 columns, <code>ump</code>), and the edges of the neighborhood graph given by two vector with the vertex indices of the connected vertices (<code>edgefr</code>, <code>edgeto</code>) and the edge-weights (<code>edgewt</code>) with the rescaled exponentially decaying similarity scores. The last parametyer, <code>lr</code>, is the learning rate.</p>
<p>In the code above, I have hard-coded a few hyperparameters: - The values for <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are fixed to 1 and hence do not appear in the expressions for the gradient - The number of repulsive gradient applications per application of the attractive gradient, called <code>negative_sampling_rate</code> in the UMAP documentation, is fixed to its default value, 5. - The repulsive gradient is multiplied with the value 0.1 before it is applied. This parameter, called <code>repulsion_strength</code> in the UMAP documentation or <span class="math inline">\(\gamma\)</span> in the UMAP paper, is normally set to 1 – but with 1, the code below does not produce a good UMAP. I am not sure why the default value does not work. This might indicate that my code deviates from the default hyperparameters somewhere else, too, requiring this change to compensate.</p>
<p>Now, we initialize the 2D UMAP coordinated with the eigenvectors corresponding to the two lowest non-zero eigenvalues of the graph Laplacian.</p>
<p>We also change the adjacency graph from CSR to COO sparse format, as this is needed by our code, and we initialize the learning rate <span class="math inline">\(\alpha\)</span> to 1.</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>ump <span class="op">=</span> evecs[:,<span class="dv">1</span>:<span class="dv">3</span>].copy()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>adj_mc_coo <span class="op">=</span> adj_mc.tocoo()</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">1.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="now-we-run-through-the-points-1300-times-each-time-reducing-the-learning-rate-a-bit." class="level3">
<h3 class="anchored" data-anchor-id="now-we-run-through-the-points-1300-times-each-time-reducing-the-learning-rate-a-bit.">Now we run through the points 1300 times, each time reducing the learning rate a bit.</h3>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> tnrange(<span class="dv">1300</span>):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    ump <span class="op">=</span> run_epoch( ump, adj_mc_coo.row, adj_mc_coo.col, adj_mc_coo.data, lr )</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ump = run_epoch( ump, adj_mc_coo.row, adj_mc_coo.col, np.ones_like(adj_mc_coo.data), lr )</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">.997</span><span class="op">*</span>lr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4c14095b5297437f8040e924b7da2685","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>plt.scatter( ump[:,<span class="dv">0</span>], ump[:,<span class="dv">1</span>], s<span class="op">=</span><span class="fl">.1</span>, c<span class="op">=</span>palette[clm] )</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>plt.gca().set_aspect(<span class="st">'equal'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="UMAP_pedestrian_files/figure-html/cell-37-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>