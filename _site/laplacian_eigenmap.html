<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mathematics of single-cell omics - Laplacian eigenmaps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Laplacian eigenmaps</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Laplacian eigenmaps were introduced by Belkin and Niyogi in ther 2003 paper <em>Laplacian Eigenmaps for Dimensionality Reduction and Data Representation</em> (<a href="https://doi.org/10.1162/089976603321780317">doi:10.1162/089976603321780317</a>)</p>
<p>We will try out this method here.</p>
<section id="load-example-data" class="level4">
<h4 class="anchored" data-anchor-id="load-example-data">Load example data</h4>
<p>Before getting into the topic, we load the usual example data and performing standard preprocessing</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-1_b421dce2d589d92e17f1944502162e2d">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>( tidyverse )</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>( Matrix )</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>( sparseMatrixStats )</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>( Seurat ) })</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ReadMtx</span>( <span class="st">"~/Downloads/ifnagrko/ifnagrko_raw_counts.mtx.gz"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~/Downloads/ifnagrko/ifnagrko_obs.csv"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~/Downloads/ifnagrko/ifnagrko_var.csv"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell.sep=</span><span class="st">","</span>, <span class="at">feature.sep=</span><span class="st">","</span>, <span class="at">skip.cell=</span><span class="dv">1</span>, <span class="at">skip.feature=</span><span class="dv">1</span>, </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtx.transpose=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> count_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-2_555e189ac5cfe19f6bdba6b638f648bf">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>count_matrix <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">CreateSeuratObject</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">NormalizeData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">RunPCA</span>( <span class="at">npcs=</span><span class="dv">20</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">FindNeighbors</span>( <span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">FindClusters</span>( <span class="at">resolution=</span><span class="fl">0.5</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">RunUMAP</span>( <span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span> ) <span class="ot">-&gt;</span> seu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Feature names cannot have underscores ('_'), replacing with dashes
('-')</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Normalizing layer: counts</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Finding variable features for layer counts</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Centering and scaling data matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PC_ 1 
Positive:  Apoe, Aldoc, Sparcl1, Sdc4, Ptn, Cmtm5, Glul, Gpr37l1, Fxyd1, Atp1b2 
       S100a1, Slc4a4, Slc1a3, Prxl2a, F3, Itm2b, Mt1, Rgcc, Prdx6, Sfxn5 
       Sat1, Scrg1, Dbi, Hes5, Luzp2, Plaat3, Pla2g7, Sash1, Plpp3, Sparc 
Negative:  Tubb5, Sox11, Tubb3, Stmn1, Jpt1, Hmgb3, Ptma, Sox4, Dlx2, Cd24a 
       Igfbpl1, Dlx6os1, Map1b, Stmn2, Abracl, Tmsb4x, Lmnb1, Cdca7, Ccnd2, Elavl4 
       Cdk4, Dcx, Arx, Uchl1, EYFP, Celf4, Dlx5, Nrxn3, H1fx, Hmgn2 
PC_ 2 
Positive:  Ctss, C1qc, Laptm5, Csf1r, Trem2, C1qa, Cx3cr1, C1qb, Tyrobp, Ly86 
       Fcer1g, Siglech, Selplg, Fcrls, Tmem119, Fcgr3, Apbb1ip, Unc93b1, Cd53, Lpcat2 
       Spi1, Pld4, Olfml3, Irf8, Ctsh, Aif1, Cd300c2, Fyb, Otulinl, Mylip 
Negative:  Rorb, Cldn10, Clu, Mt3, Ntsr2, Mfge8, S1pr1, Id4, Slc1a2, Acsl6 
       Plpp3, Sox9, Ddah1, Bcan, Cxcl14, Btbd17, Mlc1, Cspg5, Fjx1, Aqp4 
       Ntm, Acsl3, Gabrb1, Tspan7, Lsamp, Chst2, Mt2, Lhx2, Slc39a12, Glud1 
PC_ 3 
Positive:  Atp1a3, Camk2b, Snhg11, Syt1, Nrip3, Kcnj4, Scg2, Snap25, Dnm1, Pcp4 
       Icam5, Ndrg4, Eef1a2, Eno2, Ano3, Ryr2, Arpp21, Ptk2b, Gng4, Kcna4 
       Penk, Slc4a10, Snca, Gad1, Rprml, Grin2a, C1qtnf4, Shisa8, Camk2a, Kcnb2 
Negative:  Hmgb2, Top2a, Pbk, Birc5, Mki67, Cdk1, Cdca8, Spc24, Cenpf, Spc25 
       Prc1, Rrm2, Mdk, Nusap1, Tpx2, Cdca3, Knl1, Ckap2l, Esco2, Aurkb 
       Cenpm, Ccna2, Bub1, Cks2, Kif11, Hist1h3c, Hist1h1b, Hmmr, Pclaf, Fbxo5 
PC_ 4 
Positive:  C1qc, C1qa, Ctss, Trem2, Csf1r, C1qb, Cx3cr1, Laptm5, Fcer1g, Tyrobp 
       Ly86, Siglech, Selplg, Fcrls, Fcgr3, Hexb, Spi1, Cd53, Itgb5, Pld4 
       Ptgs1, Cd300c2, Aif1, Irf8, Fyb, Itgam, Cyth4, Ltc4s, Otulinl, Cd37 
Negative:  Frzb, Apod, Npy, Plp1, Vtn, Foxd3, Wnt6, Nr2f2, Edil3, Sox10 
       Gsn, Matn4, Fbln2, Aspa, Aqp1, Igf1, Plat, Lpar1, Igfbp4, Erbb3 
       Fabp7, Plppr4, Ptgds, Col23a1, Alx3, Hey2, Cd59a, Fam3c, Scd1, Mybpc1 
PC_ 5 
Positive:  Stmn2, Igfbpl1, Cd24a, Nrep, Sox4, Map1b, Stmn4, Tubb3, Shtn1, Dlx6os1 
       Dcx, Ly6h, Sox11, Jpt1, Mpped2, Stmn1, Plxna4, Pbx3, Elavl4, Uchl1 
       Runx1t1, Cald1, Foxp2, Dlx2, Gad2, Celf4, Pfn2, Dlx5, Sp8, Tubb5 
Negative:  Top2a, Pbk, Birc5, Mki67, Spc25, Cdk1, Prc1, Nusap1, Spc24, Esco2 
       Tpx2, Knl1, Aurkb, Cenpf, Cdca8, Ckap2l, Kif11, Cdca3, Hist1h3c, Hmmr 
       Ccna2, Bub1, Incenp, Hist1h2af, Ndc80, Cit, Fbxo5, Kif4, Sgo1, Kif22 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing SNN</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 18302
Number of edges: 616069

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.9191
Number of communities: 19
Elapsed time: 4 seconds</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'
This message will be shown once per session</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>15:44:19 UMAP embedding parameters a = 0.9922 b = 1.112</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>15:44:19 Read 18302 rows and found 20 numeric columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>15:44:19 Using Annoy for neighbor search, n_neighbors = 30</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>15:44:19 Building Annoy index with metric = cosine, n_trees = 50</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>0%   10   20   30   40   50   60   70   80   90   100%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[----|----|----|----|----|----|----|----|----|----|</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>**************************************************|
15:44:22 Writing NN index file to temp file /tmp/RtmpwAT4Yy/file50c1b7a618495
15:44:22 Searching Annoy index using 1 thread, search_k = 3000
15:44:29 Annoy recall = 100%
15:44:29 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
15:44:31 Initializing from normalized Laplacian + noise (using RSpectra)
15:44:34 Commencing optimization for 200 epochs, with 776086 positive edges
15:44:44 Optimization finished</code></pre>
</div>
</div>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-3_b518bb320c548b4d9254ca30f3dbbdf6">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">UMAPPlot</span>( seu, <span class="at">label=</span><span class="cn">TRUE</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We subset the object to only the “lineage”:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-4_c70784686fdf5a35b7de3cc608bdc233">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>seu[ , seu<span class="sc">$</span>seurat_clusters <span class="sc">%in%</span> <span class="fu">c</span>( <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">7</span>, <span class="dv">6</span>, <span class="dv">11</span> ) ] <span class="ot">-&gt;</span> seul</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>seul</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An object of class Seurat 
20830 features across 14303 samples within 1 assay 
Active assay: RNA (20830 features, 2000 variable features)
 3 layers present: counts, data, scale.data
 2 dimensional reductions calculated: pca, umap</code></pre>
</div>
</div>
</section>
<section id="laplacian-eigenmaps" class="level4">
<h4 class="anchored" data-anchor-id="laplacian-eigenmaps">Laplacian eigenmaps</h4>
<p>The idea of Laplacian eigenmaps is briefly as follwos: We assume that our data lives on a sub-manifold of the feature space, but is “lifted off” from it by random noise. Nevertheless, the graph formed by connecting each data point with its <span class="math inline">\(k\)</span> nearest neighbors should recapitulate that manifold’s topology and also induce a metric of map on it.</p>
<p>Spectral analysis of the neighborhood graph’s Laplacian matrix should reveal something about it, for the follwoing reason: The data points are sampled from the manifold. In the limit of infinitely many data points, the graph Laplacian matrix can be shown to converge to the manifold’s Laplace-Betrami operator.</p>
<p>There are, of course, many choices on how to put weights on the neighborhood graph. We try out one popular approach in the following.</p>
</section>
<section id="neighborhood-graph-with-gaussian-weights" class="level4">
<h4 class="anchored" data-anchor-id="neighborhood-graph-with-gaussian-weights">Neighborhood graph with Gaussian weights</h4>
<p>We use a Gaussian distance kernel to obtain edge weights, i.e., for the edge from cell (vertex) <span class="math inline">\(i\)</span> to cell <span class="math inline">\(j\)</span>, we chose <span class="math display">\[ a_{ij} = \exp\left(-\frac{d_{ij}^2}{\sigma_{ij}^2}\right),\]</span> where <span class="math inline">\(d_{ij}\)</span> is the distance between cells <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> in feature space and <span class="math inline">\(\sigma_{ij}\)</span> is a suitable kernel width.</p>
<p>For this to be a neighborhood graph’s adjacency matrix, we set <span class="math inline">\(a_{ij}=0\)</span> if <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are not neighbors. To make this concrete, we work with <span class="math inline">\(k\)</span> nearest neighbors and consider two cells neighbors if at least on of them is among the other’s <span class="math inline">\(k\)</span> nearest neighbors.</p>
<p>As we did for smoothing, we might chose that width in an “adaptive” manner, adaptiong to local density. An easy way to do so is to choose as kernel width, <span class="math inline">\(\signa_i\)</span>, for cell <span class="math inline">\(i\)</span> the cell’s distance to its <span class="math inline">\(k'\)</span>-th neighbor, using some <span class="math inline">\(k'&lt;k\)</span>.</p>
<p>In order to make the adjancy matrix symmetric, Zelnik-Manor and Perona (2003) suggest to let <span class="math inline">\(\sigma_{ij}^2=\sigma_i\sigma_j\)</span>, i.e., we set the squared kernel width used when calculating the weight for the edge from cell <span class="math inline">\(i\)</span> to cell <span class="math inline">\(j\)</span> to the product of the distances of both cells’ respective <span class="math inline">\(k'\)</span>-th nearest neighbor.</p>
</section>
<section id="calculating-the-neighborhood-graph" class="level4">
<h4 class="anchored" data-anchor-id="calculating-the-neighborhood-graph">Calculating the neighborhood graph</h4>
<p>We get for each cell its <span class="math inline">\(k=50\)</span> nearest neighbors:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-5_bec37ded94ac7f1e287e79c087ddbbc5">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>FNN<span class="sc">::</span><span class="fu">get.knn</span>( <span class="fu">Embeddings</span>(seul,<span class="st">"pca"</span>), <span class="at">k=</span><span class="dv">50</span> ) <span class="ot">-&gt;</span> nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We set <span class="math inline">\(k'=20\)</span> and hence take the <span class="math inline">\(sigma_i\)</span> from the 20th column of the NN distance table.</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-6_aae0c5b53ae6f0cc4f09cbcf4d71f286">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> nn<span class="sc">$</span>nn.dist[,<span class="dv">20</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we obtain the adjacency matrix as follows:</p>
<ul>
<li>For each <span class="math inline">\(i\)</span> from 1 to <span class="math inline">\(k\)</span>, make a list of edges, namely from each cell <span class="math inline">\(j\)</span> to its <span class="math inline">\(i\)</span>-th neighbor <span class="math inline">\(j_i\)</span>, setting the edge weight to <span class="math inline">\(\exp(-d(j,j_i)^2/(\sigma(j)\sigma{j_i}))\)</span>, where <span class="math inline">\(d(j,j')\)</span> is the distance of from cell <span class="math inline">\(j\)</span> to its <span class="math inline">\(i\)</span>-th neighbor and <span class="math inline">\(\sigma(j)\)</span> is the distance of cell <span class="math inline">\(j\)</span> to its <span class="math inline">\(k'\)</span>-th neighbor.</li>
<li>We concatenate these edge lists to one long one.</li>
<li>Then, to properly symmetrize the matrix, we proceed as follows:
<ul>
<li>For each edge, we sort the cell indices, such that the “left” index is the numerically smaller and the “right” index is the larger one.</li>
<li>If two cells are mutual nearest neighbors, their edge appears twice (first with swapped indices, now with the same indices). We only keep one. Note that we should only check the vertex indices for equality, not the weights, to avoid falling for numerical inaccuricies (as floating point multiplication is not exactly commutative).</li>
<li>We pass the edgelist to the <code>sparseMatrix</code> function to form a sparse matrix. We request a symmetric matrix, causing the function to add the missing lower triangular part.<br>
</li>
</ul></li>
</ul>
<p>Here is the code:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-7_a9a9e724b78489d21dfbf5ccda4d4b79">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ncells <span class="ot">&lt;-</span> <span class="fu">nrow</span>(nn<span class="sc">$</span>nn.index)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfr</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(nn<span class="sc">$</span>nn.index), <span class="cf">function</span>(i) </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell1 =</span> <span class="dv">1</span><span class="sc">:</span>ncells, </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell2 =</span> nn<span class="sc">$</span>nn.index[,i], </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight =</span> <span class="fu">exp</span>( <span class="sc">-</span> nn<span class="sc">$</span>nn.dist[,i]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> ( sigma <span class="sc">*</span> sigma[nn<span class="sc">$</span>nn.index[,i]] ) ) ) ) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>( </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">left =</span> <span class="fu">pmin</span>( cell1, cell2 ),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">right =</span> <span class="fu">pmax</span>( cell1, cell2 ) ) <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>( left, right ) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>( left, right, weight ) <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>( left, right, <span class="at">.keep_all=</span><span class="cn">TRUE</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>{ <span class="fu">sparseMatrix</span>( <span class="at">i=</span>.<span class="sc">$</span>left, <span class="at">j=</span>.<span class="sc">$</span>right, <span class="at">x=</span>.<span class="sc">$</span>weight, </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">symmetric=</span><span class="cn">TRUE</span>, <span class="at">dims=</span><span class="fu">c</span>(ncells,ncells) ) } <span class="ot">-&gt;</span> adjm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Writing <span class="math inline">\(A\)</span> for this adjacency matrix and <span class="math inline">\(D\)</span> for the diagonal matrix of vertex degrees (<span class="math inline">\(D_{ij}=\delta_{ij}\sum_{j'}A_{ij'}\)</span>), we obtain the scaled graph Laplacian as <span class="math inline">\(L = I - D^{-1/2} A D^{-1/2}\)</span>.</p>
<p>We get the smallest (by magnitude) eigenvalues and their eigenvectors.</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-8_0364c462a0b08b1f1ca1d254f4553704">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>invsqrtdegdiag <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span>ncells, <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span>ncells, <span class="at">x=</span><span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">rowSums</span>(adjm)), <span class="at">symmetric=</span><span class="cn">TRUE</span> )</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>scaled_laplacian <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span>ncells, <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span>ncells, <span class="at">x=</span><span class="dv">1</span>, <span class="at">symmetric=</span><span class="cn">TRUE</span> ) <span class="sc">-</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  invsqrtdegdiag <span class="sc">%*%</span> adjm <span class="sc">%*%</span> invsqrtdegdiag</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>RSpectra<span class="sc">::</span><span class="fu">eigs_sym</span>( scaled_laplacian, <span class="dv">5</span>, <span class="at">which=</span><span class="st">"SM"</span> ) <span class="ot">-&gt;</span> eig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The smallest eigenvalue is, as expected, 0:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-9_075719ac3164fead1380ba7c942b2fd8">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>eig<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.819817e-03 2.641315e-03 2.175909e-03 4.455835e-04 4.656835e-16</code></pre>
</div>
</div>
<p>Here is a plot of the data points, using as 2D coordinates the eigenvectors corresponding to the two smallest non-zero eigenvalues. We colour by Leiden cluster.</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-10_685288df0d8112b7fc7f3dce5f1465f2">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(eig<span class="sc">$</span>vectors) <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_column</span>( <span class="at">cluster=</span>seul<span class="sc">$</span>seurat_clusters) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>ggplot <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>( <span class="at">x=</span>V4, <span class="at">y=</span>V3, <span class="at">col=</span>cluster), <span class="at">size=</span>.<span class="dv">1</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if
`.name_repair` is omitted as of tibble 2.0.0.
ℹ Using compatibility `.name_repair`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For comparison, the UMAP, with the same colouring:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-11_da6344744aa5ef3f564b9be9f280b54b">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Embeddings</span>(seul,<span class="st">"umap"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">add_column</span>( <span class="at">cluster=</span>seul<span class="sc">$</span>seurat_clusters) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ggplot <span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>( <span class="at">x=</span>umap_1, <span class="at">y=</span>umap_2, <span class="at">col=</span>cluster), <span class="at">size=</span>.<span class="dv">1</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="swiss-roll" class="level4">
<h4 class="anchored" data-anchor-id="swiss-roll">Swiss roll</h4>
<p>To make a Swiss role, prepare a biscuit batter and bake it in a tray to obtain a spongy rectangular biscuit cake. Put a layer of jam, then a thick layer of cream on top, the roll up the layered cake.</p>
<p>The Swiss role has inspired a standard “test manifold” to study dimension reduction:</p>
<p>First, we sample point from a 2D rectangle:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-12_37206a5ff9ff1a62786e79fc3f9f2ed1">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>( <span class="dv">1324</span> )</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="fu">runif</span>( n, <span class="dv">0</span>, <span class="dv">50</span> )</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> <span class="fu">runif</span>( n, <span class="dv">0</span>, <span class="dv">6</span><span class="sc">*</span>pi )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, roll up the rectangle, using <span class="math inline">\(y_0\)</span> both as rolling angle and as radius. For the radius, add some noise to make the biscuit fluffy.</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-13_b055862842c32444e0c4412c7c88c45c">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> y0 <span class="sc">+</span> <span class="fu">runif</span>( n, <span class="dv">0</span>, <span class="dv">1</span> )</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  x0,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  r <span class="sc">*</span> <span class="fu">cos</span>( y0 ),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  r <span class="sc">*</span> <span class="fu">sin</span>( y0 ) ) <span class="ot">-&gt;</span> x3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a plot of the roll, looking head-on:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-14_d57304b68648989c1c1d7a6203b285f7">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x3[,<span class="dv">2</span>], x3[,<span class="dv">3</span>], <span class="at">cex=</span>.<span class="dv">1</span>, <span class="at">asp=</span><span class="dv">1</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and from the side:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-15_f55971d39338487415e95c1986dc3ea6">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( x3[,<span class="dv">1</span>], x3[,<span class="dv">2</span>], <span class="at">cex=</span>.<span class="dv">1</span>, <span class="at">asp=</span><span class="dv">1</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, let’s embed this 3D object into a 7D space, by chosing three random but orthonormal basis vectors. To do so, we chose three random vectors</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-16_d148320f4c1ec86ba9131f62b6d2aa9d">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>random_vecs <span class="ot">&lt;-</span> <span class="fu">matrix</span>( <span class="fu">rnorm</span>(<span class="dv">21</span>), <span class="at">nrow =</span> <span class="dv">7</span>, <span class="at">ncol =</span> <span class="dv">3</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>then orthogonalize them using QR decomposition (which is essentially a sophisticated variant of Gram-Schmidt)</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-17_9d18971ee87349d3b94d4d82f831029c">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>random_orthonormal_basis <span class="ot">&lt;-</span> <span class="fu">qr.Q</span>( <span class="fu">qr</span>( random_vecs ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-18_f65bf9d05bf508ddc9ed624f52782115">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>x3 <span class="sc">%*%</span> <span class="fu">t</span>(random_orthonormal_basis) <span class="ot">-&gt;</span> x</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            [,1]       [,2]      [,3]       [,4]      [,5]      [,6]      [,7]
[1,]   0.4144157  -8.778192 0.3285658  4.7389610 -5.612610 -4.126349  4.567517
[2,]  -6.8567192 -20.994387 7.1659708 -0.1867122 12.491133 17.531947 -3.382384
[3,] -15.0072735 -33.209732 8.2908585 14.7320429 15.170257 21.642549 -1.562077
[4,] -12.0583660 -44.033499 8.4152476 18.5598476  5.050857 13.500057  5.503569
[5,]   3.6573425  -7.930982 2.6781130 -7.5061441 -1.509872  1.010143  1.174632
[6,]  -8.1042127 -28.569759 5.3217416 12.8346638  3.158864  8.563515  3.707611</code></pre>
</div>
</div>
<p>Can we recover the initial 2D sheet (x0, y0) using eigenmaps?</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-19_ed0fead580f08a8cdca5a9f8f8cdc7fc">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>FNN<span class="sc">::</span><span class="fu">get.knn</span>( x, <span class="at">k=</span><span class="dv">30</span> ) <span class="ot">-&gt;</span> nn</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>nn<span class="sc">$</span>nn.dist[,<span class="dv">18</span>] <span class="ot">-&gt;</span> sigma</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfr</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(nn<span class="sc">$</span>nn.index), <span class="cf">function</span>(i) </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>( </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell1 =</span> <span class="dv">1</span><span class="sc">:</span>n, </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cell2 =</span> nn<span class="sc">$</span>nn.index[,i], </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight =</span> <span class="fu">exp</span>( <span class="sc">-</span> nn<span class="sc">$</span>nn.dist[,i]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> ( sigma <span class="sc">*</span> sigma[nn<span class="sc">$</span>nn.index[,i]] ) ) ) ) <span class="sc">%&gt;%</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>( </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">left =</span> <span class="fu">pmin</span>( cell1, cell2 ),</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">right =</span> <span class="fu">pmax</span>( cell1, cell2 ) ) <span class="sc">%&gt;%</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>( left, right ) <span class="sc">%&gt;%</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>( left, right, weight ) <span class="sc">%&gt;%</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>( left, right, <span class="at">.keep_all=</span><span class="cn">TRUE</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>{ <span class="fu">sparseMatrix</span>( <span class="at">i=</span>.<span class="sc">$</span>left, <span class="at">j=</span>.<span class="sc">$</span>right, <span class="at">x=</span>.<span class="sc">$</span>weight, </span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">symmetric=</span><span class="cn">TRUE</span>, <span class="at">dims=</span><span class="fu">c</span>(n,n) ) } <span class="ot">-&gt;</span> adjm</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>invsqrtdegdiag <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span>n, <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span>n, <span class="at">x=</span><span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">rowSums</span>(adjm)), <span class="at">symmetric=</span><span class="cn">TRUE</span> )</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>scaled_laplacian <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span>n, <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span>n, <span class="at">x=</span><span class="dv">1</span>, <span class="at">symmetric=</span><span class="cn">TRUE</span> ) <span class="sc">-</span> </span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  invsqrtdegdiag <span class="sc">%*%</span> adjm <span class="sc">%*%</span> invsqrtdegdiag</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>RSpectra<span class="sc">::</span><span class="fu">eigs_sym</span>( scaled_laplacian, <span class="dv">5</span>, <span class="at">which=</span><span class="st">"SM"</span> ) <span class="ot">-&gt;</span> eig</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>eig<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  2.495667e-03  1.544439e-03  1.290361e-03  2.784866e-04 -3.108038e-15</code></pre>
</div>
</div>
<p>The eigenmap, coloured by y0:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-20_4b1ff21db86fce78a857836d0d8cb5d5">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(eig<span class="sc">$</span>vectors) <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_column</span>( x0, y0 ) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>ggplot <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>( <span class="at">x=</span>V4, <span class="at">y=</span>V3, <span class="at">col=</span>y0), <span class="at">size=</span>.<span class="dv">1</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The eigenmap, coloured by x0:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-21_9a88865222752fc5559409f436b768b7">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(eig<span class="sc">$</span>vectors) <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_column</span>( x0, y0 ) <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>ggplot <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>( <span class="at">x=</span>V4, <span class="at">y=</span>V3, <span class="at">col=</span>x0), <span class="at">size=</span>.<span class="dv">1</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>How does UMAP fare?</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-22_194bae17f34f057ab2534cba85ce6584">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>uwot<span class="sc">::</span><span class="fu">umap</span>(x) <span class="ot">-&gt;</span> ump</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Colour by x0:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-23_cd80183199dcf8ecd4ca43ab3d58c4d1">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(ump) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_column</span>( x0, y0 ) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>ggplot <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>( <span class="at">x=</span>V1, <span class="at">y=</span>V2, <span class="at">col=</span>x0), <span class="at">size=</span>.<span class="dv">1</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and by y0:</p>
<div class="cell" data-hash="laplacian_eigenmap_cache/html/unnamed-chunk-24_32c13d228daddc9440276be62011970a">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(ump) <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_column</span>( x0, y0 ) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>ggplot <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>( <span class="at">x=</span>V1, <span class="at">y=</span>V2, <span class="at">col=</span>y0), <span class="at">size=</span>.<span class="dv">1</span> ) <span class="sc">+</span> <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="laplacian_eigenmap_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>